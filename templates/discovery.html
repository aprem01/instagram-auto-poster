{% extends "base.html" %}

{% block title %}Discovery Optimizer - DVCCC Content Manager{% endblock %}

{% block content %}
<style>
    .discovery-layout {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .top-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
    }

    @media (max-width: 1200px) {
        .top-section {
            grid-template-columns: 1fr;
        }
    }

    .panel {
        background: white;
        border-radius: 16px;
        padding: 28px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }

    .section-title {
        font-size: 1.4rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .section-subtitle {
        color: #6b7280;
        font-size: 0.9rem;
        margin-bottom: 20px;
    }

    /* Tab Navigation */
    .tab-nav {
        display: flex;
        gap: 4px;
        background: #f3f4f6;
        padding: 4px;
        border-radius: 12px;
        margin-bottom: 24px;
    }

    .tab-btn {
        flex: 1;
        padding: 12px 20px;
        border: none;
        background: transparent;
        border-radius: 10px;
        font-size: 0.95rem;
        font-weight: 600;
        color: #6b7280;
        cursor: pointer;
        transition: all 0.2s;
    }

    .tab-btn:hover {
        color: #374151;
    }

    .tab-btn.active {
        background: white;
        color: #667eea;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    /* Caption Input */
    .caption-input {
        width: 100%;
        min-height: 160px;
        padding: 16px;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        font-size: 1rem;
        font-family: inherit;
        resize: vertical;
        transition: border-color 0.2s;
    }

    .caption-input:focus {
        outline: none;
        border-color: #667eea;
    }

    .caption-input::placeholder {
        color: #9ca3af;
    }

    /* Topic Input */
    .topic-input {
        width: 100%;
        padding: 14px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        font-size: 1rem;
        transition: border-color 0.2s;
    }

    .topic-input:focus {
        outline: none;
        border-color: #667eea;
    }

    .char-count {
        text-align: right;
        font-size: 0.85rem;
        color: #9ca3af;
        margin-top: 8px;
    }

    /* Trending Topics */
    .trending-section {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #e5e7eb;
    }

    .trending-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .trending-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .trending-chip {
        padding: 8px 14px;
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border: none;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
        color: #92400e;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .trending-chip:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
    }

    .trending-score {
        background: rgba(146, 64, 14, 0.15);
        padding: 2px 6px;
        border-radius: 8px;
        font-size: 0.75rem;
    }

    /* Selector Groups */
    .selector-group {
        margin-top: 20px;
    }

    .selector-label {
        font-weight: 600;
        color: #374151;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
    }

    .selector-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .chip {
        padding: 8px 14px;
        background: #f3f4f6;
        border: 2px solid transparent;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 500;
        color: #4b5563;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .chip:hover {
        background: #e5e7eb;
    }

    .chip.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    /* Action Buttons */
    .action-btn {
        width: 100%;
        padding: 14px 28px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        margin-top: 24px;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    .action-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .action-btn.secondary {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .action-btn .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255,255,255,0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        display: none;
    }

    .action-btn.loading .spinner {
        display: block;
    }

    .action-btn.loading .btn-text {
        display: none;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Optimization Cards Grid */
    .opt-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
        margin-bottom: 24px;
    }

    @media (max-width: 1200px) {
        .opt-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 600px) {
        .opt-grid {
            grid-template-columns: 1fr;
        }
    }

    .opt-card {
        background: white;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        transition: all 0.3s;
        border: 2px solid transparent;
    }

    .opt-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    }

    .opt-card.seo {
        border-color: #3b82f6;
    }

    .opt-card.aio {
        border-color: #8b5cf6;
    }

    .opt-card.geo {
        border-color: #10b981;
    }

    .opt-card.aeo {
        border-color: #f59e0b;
    }

    .opt-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
    }

    .opt-icon {
        font-size: 2rem;
    }

    .opt-grade {
        font-size: 1.8rem;
        font-weight: 800;
    }

    .opt-card.seo .opt-grade { color: #3b82f6; }
    .opt-card.aio .opt-grade { color: #8b5cf6; }
    .opt-card.geo .opt-grade { color: #10b981; }
    .opt-card.aeo .opt-grade { color: #f59e0b; }

    .opt-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 4px;
    }

    .opt-focus {
        font-size: 0.8rem;
        color: #6b7280;
        margin-bottom: 8px;
    }

    .opt-platform {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background: #f3f4f6;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        color: #4b5563;
        margin-bottom: 12px;
    }

    .opt-metric {
        font-size: 0.8rem;
        color: #059669;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .opt-tips {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #e5e7eb;
    }

    .opt-tip {
        font-size: 0.8rem;
        color: #6b7280;
        padding: 6px 0;
        display: flex;
        align-items: flex-start;
        gap: 6px;
    }

    .opt-tip::before {
        content: '‚Üí';
        color: #9ca3af;
        flex-shrink: 0;
    }

    /* Results Panel */
    .results-panel {
        display: none;
    }

    .results-panel.visible {
        display: block;
    }

    /* Generated Caption Display */
    .generated-caption-box {
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        border: 2px solid #86efac;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        position: relative;
    }

    .generated-caption-label {
        font-size: 0.85rem;
        font-weight: 600;
        color: #166534;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .generated-caption-text {
        font-size: 1rem;
        color: #1f2937;
        line-height: 1.6;
        white-space: pre-wrap;
    }

    .copy-caption-btn {
        position: absolute;
        top: 12px;
        right: 12px;
        background: white;
        border: 1px solid #86efac;
        border-radius: 8px;
        padding: 8px 14px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 500;
        color: #166534;
        transition: all 0.2s;
    }

    .copy-caption-btn:hover {
        background: #166534;
        color: white;
    }

    .copy-caption-btn.copied {
        background: #166534;
        color: white;
    }

    /* Score Card */
    .overall-score-card {
        text-align: center;
        padding: 24px;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 16px;
        margin-bottom: 24px;
    }

    .overall-grade {
        font-size: 4rem;
        font-weight: 800;
        line-height: 1;
        margin-bottom: 8px;
    }

    .overall-label {
        font-size: 1rem;
        color: #6b7280;
        font-weight: 500;
    }

    /* Hashtag Container */
    .hashtag-container {
        background: #f8fafc;
        border-radius: 12px;
        padding: 16px;
        position: relative;
        margin-top: 20px;
    }

    .hashtag-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding-right: 80px;
    }

    .hashtag-tag {
        background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
        color: #667eea;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .copy-btn {
        position: absolute;
        top: 12px;
        right: 12px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 8px 14px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 500;
        color: #6b7280;
        transition: all 0.2s;
    }

    .copy-btn:hover {
        background: #f3f4f6;
    }

    .copy-btn.copied {
        background: #22c55e;
        color: white;
        border-color: #22c55e;
    }

    /* Info Callout */
    .info-callout {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        border: 1px solid #93c5fd;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 24px;
        display: flex;
        gap: 12px;
        align-items: flex-start;
    }

    .info-callout-icon {
        font-size: 1.4rem;
        flex-shrink: 0;
    }

    .info-callout-text {
        color: #1e40af;
        font-size: 0.9rem;
        line-height: 1.5;
    }

    /* Posting Times */
    .time-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 16px;
    }

    .time-card {
        background: #f0fdf4;
        border-radius: 10px;
        padding: 14px;
    }

    .time-card.best {
        background: linear-gradient(135deg, #dcfce7 0%, #d1fae5 100%);
        border: 1px solid #86efac;
    }

    .time-label {
        font-size: 0.8rem;
        color: #6b7280;
        text-transform: uppercase;
        margin-bottom: 6px;
    }

    .time-value {
        font-size: 1.1rem;
        font-weight: 700;
        color: #166534;
    }

    .days-chips {
        display: flex;
        gap: 6px;
        margin-top: 12px;
        flex-wrap: wrap;
    }

    .day-chip {
        background: #e0e7ff;
        color: #4338ca;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    /* Improvement Box */
    .improvement-box {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border: 2px solid #f59e0b;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .improvement-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
    }

    .improvement-icon {
        font-size: 1.5rem;
    }

    .improvement-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #92400e;
    }

    .improvement-subtitle {
        font-size: 0.9rem;
        color: #a16207;
        margin-bottom: 12px;
    }

    .improvement-list {
        margin: 0 0 16px 20px;
        padding: 0;
    }

    .improvement-list li {
        font-size: 0.9rem;
        color: #92400e;
        margin-bottom: 6px;
    }

    .improve-btn {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 12px 24px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .improve-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
    }

    /* Hidden by default */
    .hidden {
        display: none !important;
    }

    /* Analyzed Caption Box */
    .analyzed-caption-box {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        border: 2px solid #93c5fd;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .analyzed-caption-label {
        font-size: 0.85rem;
        font-weight: 600;
        color: #1e40af;
    }

    .analyzed-caption-text {
        font-size: 0.95rem;
        color: #1f2937;
        line-height: 1.6;
        white-space: pre-wrap;
        max-height: 150px;
        overflow-y: auto;
    }

    .optimize-ai-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 18px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .optimize-ai-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    /* Score Description */
    .score-description {
        font-size: 0.9rem;
        color: #6b7280;
        margin-top: 8px;
    }

    /* Score Card Colors */
    .overall-score-card.grade-a {
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    }
    .overall-score-card.grade-b {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    }
    .overall-score-card.grade-c {
        background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%);
    }
    .overall-score-card.grade-d {
        background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
    }
    .overall-score-card.grade-f {
        background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
    }
</style>

<div class="info-callout">
    <span class="info-callout-icon">üöÄ</span>
    <div class="info-callout-text">
        <strong>Discovery Optimizer</strong> - Maximize your content's reach with comprehensive optimization across
        <strong>SEO</strong> (Google/Bing), <strong>AIO</strong> (AI Overviews), <strong>GEO</strong> (ChatGPT/Perplexity), and <strong>AEO</strong> (Voice Search).
        Generate optimized captions or analyze your existing content.
    </div>
</div>

<div class="discovery-layout">
    <!-- Top Section: Input Panel and Trending -->
    <div class="top-section">
        <!-- Input Panel -->
        <div class="panel">
            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('generate')">‚ú® Generate Caption</button>
                <button class="tab-btn" onclick="switchTab('analyze')">üîç Analyze Existing</button>
            </div>

            <!-- Generate Tab -->
            <div class="tab-content active" id="generateTab">
                <h3 class="section-title">
                    <span>‚ú®</span> AI Caption Generator
                </h3>
                <p class="section-subtitle">Enter a topic and get an optimized caption with SEO/AIO/GEO/AEO best practices</p>

                <input
                    type="text"
                    class="topic-input"
                    id="topicInput"
                    placeholder="Enter your topic (e.g., Teen dating violence warning signs)"
                />

                <!-- Trending Topics -->
                <div class="trending-section">
                    <div class="trending-label">
                        <span>üî•</span> Trending Topics
                    </div>
                    <div class="trending-chips" id="trendingChips">
                        <button class="trending-chip" onclick="selectTrending('Teen Dating Violence Awareness')">
                            #TDVAM <span class="trending-score">95</span>
                        </button>
                        <button class="trending-chip" onclick="selectTrending('Healthy Relationship Education')">
                            Healthy Relationships <span class="trending-score">92</span>
                        </button>
                        <button class="trending-chip" onclick="selectTrending('Digital Safety & Technology Abuse')">
                            Digital Safety <span class="trending-score">90</span>
                        </button>
                    </div>
                </div>

                <!-- Optimization Focus -->
                <div class="selector-group">
                    <div class="selector-label">
                        <span>üéØ</span> Optimization Focus
                    </div>
                    <div class="selector-chips" id="focusSelector">
                        <button type="button" class="chip active" data-value="balanced" onclick="selectChip(this, 'focus')">
                            ‚öñÔ∏è Balanced
                        </button>
                        <button type="button" class="chip" data-value="seo" onclick="selectChip(this, 'focus')">
                            üîç SEO
                        </button>
                        <button type="button" class="chip" data-value="aio" onclick="selectChip(this, 'focus')">
                            ü§ñ AIO
                        </button>
                        <button type="button" class="chip" data-value="geo" onclick="selectChip(this, 'focus')">
                            üí¨ GEO
                        </button>
                        <button type="button" class="chip" data-value="aeo" onclick="selectChip(this, 'focus')">
                            üîä AEO
                        </button>
                    </div>
                </div>

                <button class="action-btn secondary" id="generateBtn" onclick="generateCaption()">
                    <span class="spinner"></span>
                    <span class="btn-text">‚ú® Generate Optimized Caption</span>
                </button>
            </div>

            <!-- Analyze Tab -->
            <div class="tab-content" id="analyzeTab">
                <h3 class="section-title">
                    <span>üîç</span> Analyze Your Caption
                </h3>
                <p class="section-subtitle">Paste your existing caption to get optimization recommendations</p>

                <textarea
                    class="caption-input"
                    id="captionInput"
                    placeholder="Paste your existing caption here..."
                    oninput="updateCharCount()"
                ></textarea>
                <div class="char-count"><span id="charCount">0</span> characters</div>

                <button class="action-btn" id="analyzeBtn" onclick="analyzeCaption()">
                    <span class="spinner"></span>
                    <span class="btn-text">üöÄ Analyze for Discovery</span>
                </button>
            </div>

            <!-- Shared Selectors -->
            <div class="selector-group">
                <div class="selector-label">
                    <span>üéØ</span> Target Audience
                </div>
                <div class="selector-chips" id="audienceSelector">
                    <button type="button" class="chip active" data-value="general" onclick="selectChip(this, 'audience')">
                        üë• General
                    </button>
                    <button type="button" class="chip" data-value="youth" onclick="selectChip(this, 'audience')">
                        üéì Youth (Under 24)
                    </button>
                    <button type="button" class="chip" data-value="survivors" onclick="selectChip(this, 'audience')">
                        üíú Survivors
                    </button>
                    <button type="button" class="chip" data-value="donors" onclick="selectChip(this, 'audience')">
                        üíù Donors
                    </button>
                    <button type="button" class="chip" data-value="professionals" onclick="selectChip(this, 'audience')">
                        üëî Professionals
                    </button>
                    <button type="button" class="chip" data-value="spanish" onclick="selectChip(this, 'audience')">
                        üåé Spanish
                    </button>
                    <button type="button" class="chip" data-value="event" onclick="selectChip(this, 'audience')">
                        üìÖ Event
                    </button>
                    <button type="button" class="chip" data-value="volunteers" onclick="selectChip(this, 'audience')">
                        ü§ù Volunteers
                    </button>
                </div>
            </div>

            <div class="selector-group">
                <div class="selector-label">
                    <span>üì±</span> Platform <span style="font-size: 0.75rem; color: #9ca3af; font-weight: 400;">(optimized for each)</span>
                </div>
                <div class="selector-chips" id="platformSelector">
                    <button type="button" class="chip active" data-value="instagram" onclick="selectChip(this, 'platform')">
                        üì∏ Instagram
                    </button>
                    <button type="button" class="chip" data-value="facebook" onclick="selectChip(this, 'platform')">
                        üìò Facebook
                    </button>
                    <button type="button" class="chip" data-value="tiktok" onclick="selectChip(this, 'platform')">
                        üéµ TikTok
                    </button>
                    <button type="button" class="chip" data-value="linkedin" onclick="selectChip(this, 'platform')">
                        üíº LinkedIn
                    </button>
                    <button type="button" class="chip" data-value="twitter" onclick="selectChip(this, 'platform')">
                        üê¶ X/Twitter
                    </button>
                </div>
            </div>
        </div>

        <!-- A-Grade Tips Panel -->
        <div class="panel">
            <h3 class="section-title">
                <span>üèÜ</span> Get an A-Grade Caption
            </h3>
            <p class="section-subtitle">Include these elements for maximum discoverability</p>

            <div style="display: grid; gap: 12px;">
                <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 12px; padding: 14px; border-left: 4px solid #22c55e;">
                    <div style="font-weight: 700; color: #166534; margin-bottom: 6px;">‚úÖ Must-Have Keywords</div>
                    <div style="font-size: 0.85rem; color: #15803d; line-height: 1.5;">
                        <span style="background:#bbf7d0;padding:2px 6px;border-radius:4px;margin:2px;">Chester County</span>
                        <span style="background:#bbf7d0;padding:2px 6px;border-radius:4px;margin:2px;">free</span>
                        <span style="background:#bbf7d0;padding:2px 6px;border-radius:4px;margin:2px;">confidential</span>
                        <span style="background:#bbf7d0;padding:2px 6px;border-radius:4px;margin:2px;">support</span>
                        <span style="background:#bbf7d0;padding:2px 6px;border-radius:4px;margin:2px;">safe</span>
                    </div>
                </div>
                <div style="background: #eff6ff; border-radius: 12px; padding: 14px; border-left: 4px solid #3b82f6;">
                    <div style="font-weight: 700; color: #1e40af; margin-bottom: 4px;">üì£ Strong Call-to-Action</div>
                    <div style="font-size: 0.85rem; color: #3b82f6;">Use: "Call", "Visit dvcccpa.org", "Reach out", "Get help"</div>
                </div>
                <div style="background: #f5f3ff; border-radius: 12px; padding: 14px; border-left: 4px solid #8b5cf6;">
                    <div style="font-weight: 700; color: #5b21b6; margin-bottom: 4px;">‚ùì Include a Question</div>
                    <div style="font-size: 0.85rem; color: #7c3aed;">Questions boost engagement: "Are you okay?" "Need support?"</div>
                </div>
                <div style="background: #ecfdf5; border-radius: 12px; padding: 14px; border-left: 4px solid #10b981;">
                    <div style="font-weight: 700; color: #065f46; margin-bottom: 4px;">üèõÔ∏è Authority Language</div>
                    <div style="font-size: 0.85rem; color: #059669;">Use: "We provide", "We help", "DVCCC offers"</div>
                </div>
                <div style="background: #fffbeb; border-radius: 12px; padding: 14px; border-left: 4px solid #f59e0b;">
                    <div style="font-weight: 700; color: #92400e; margin-bottom: 4px;">üìè Good Structure</div>
                    <div style="font-size: 0.85rem; color: #d97706;">2-3 short paragraphs, 100+ characters total</div>
                </div>
            </div>

            <!-- Quick Example -->
            <div style="margin-top: 16px; padding: 14px; background: linear-gradient(135deg, #fdf4ff 0%, #fae8ff 100%); border-radius: 12px; border: 1px dashed #c026d3;">
                <div style="font-weight: 700; color: #86198f; margin-bottom: 8px; font-size: 0.9rem;">üíú A-Grade Example:</div>
                <div style="font-size: 0.8rem; color: #701a75; font-style: italic; line-height: 1.5;">
                    "Are you or someone you love in an unhealthy relationship? üíú<br><br>
                    DVCCC provides free, confidential support to survivors in Chester County, PA. You deserve to feel safe.<br><br>
                    We help with shelter, counseling, and advocacy. Reach out today at dvcccpa.org üí™"
                </div>
            </div>
        </div>
    </div>

    <!-- Optimization Cards (shown after analysis) -->
    <div class="opt-grid hidden" id="optCards">
        <div class="opt-card seo">
            <div class="opt-header">
                <span class="opt-icon">üîç</span>
                <span class="opt-grade" id="seoGrade">-</span>
            </div>
            <div class="opt-title">SEO</div>
            <div class="opt-focus">Keywords & Links</div>
            <div class="opt-platform">üåê Google / Bing</div>
            <div class="opt-metric">üìà <span id="seoMetric">Website Traffic</span></div>
            <div class="opt-tips" id="seoTips"></div>
        </div>

        <div class="opt-card aio">
            <div class="opt-header">
                <span class="opt-icon">ü§ñ</span>
                <span class="opt-grade" id="aioGrade">-</span>
            </div>
            <div class="opt-title">AIO</div>
            <div class="opt-focus">Clarity & Structure</div>
            <div class="opt-platform">‚ú® Google AI Overviews</div>
            <div class="opt-metric">üìã <span id="aioMetric">Summary Presence</span></div>
            <div class="opt-tips" id="aioTips"></div>
        </div>

        <div class="opt-card geo">
            <div class="opt-header">
                <span class="opt-icon">üí¨</span>
                <span class="opt-grade" id="geoGrade">-</span>
            </div>
            <div class="opt-title">GEO</div>
            <div class="opt-focus">Authority & Reputation</div>
            <div class="opt-platform">üß† ChatGPT / Perplexity</div>
            <div class="opt-metric">üè∑Ô∏è <span id="geoMetric">Brand Citations</span></div>
            <div class="opt-tips" id="geoTips"></div>
        </div>

        <div class="opt-card aeo">
            <div class="opt-header">
                <span class="opt-icon">üîä</span>
                <span class="opt-grade" id="aeoGrade">-</span>
            </div>
            <div class="opt-title">AEO</div>
            <div class="opt-focus">Direct Answers</div>
            <div class="opt-platform">üéôÔ∏è Siri / Alexa / Snippets</div>
            <div class="opt-metric">üó£Ô∏è <span id="aeoMetric">Voice Answer</span></div>
            <div class="opt-tips" id="aeoTips"></div>
        </div>
    </div>

    <!-- Results Panel -->
    <div class="panel results-panel" id="resultsPanel">
        <!-- Generated Caption Display -->
        <div class="generated-caption-box hidden" id="generatedCaptionBox">
            <div class="generated-caption-label">‚ú® Generated Caption</div>
            <button class="copy-caption-btn" onclick="copyGeneratedCaption()">üìã Copy</button>
            <div class="generated-caption-text" id="generatedCaptionText"></div>
        </div>

        <!-- Analyzed Caption Display (for analyze tab) -->
        <div class="analyzed-caption-box hidden" id="analyzedCaptionBox">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div class="analyzed-caption-label">üìù Your Caption</div>
                <button class="optimize-ai-btn" onclick="optimizeWithAI()">
                    ‚ú® Optimize with AI
                </button>
            </div>
            <div class="analyzed-caption-text" id="analyzedCaptionText"></div>
        </div>

        <!-- Overall Score -->
        <div class="overall-score-card">
            <div class="overall-grade" id="overallGrade">-</div>
            <div class="overall-label">Overall Discovery Score</div>
            <div class="score-description" id="scoreDescription"></div>
        </div>

        <!-- Improvement Suggestions (shown when score needs work) -->
        <div class="improvement-box hidden" id="improvementBox">
            <div class="improvement-header">
                <span class="improvement-icon">üí°</span>
                <span class="improvement-title">Boost Your Score</span>
            </div>
            <p class="improvement-subtitle">Add these elements for a better score:</p>
            <ul class="improvement-list" id="improvementList"></ul>
            <button class="improve-btn" onclick="regenerateImproved()" id="improveBtn">
                ‚ú® Generate Optimized Version
            </button>
        </div>

        <!-- Hashtags -->
        <h4 style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <span>#Ô∏è‚É£</span> Recommended Hashtags
        </h4>
        <div class="hashtag-container">
            <button class="copy-btn" onclick="copyHashtags()">
                <span id="copyIcon">üìã</span> <span id="copyText">Copy All</span>
            </button>
            <div class="hashtag-list" id="hashtagList"></div>
        </div>

        <!-- Posting Times -->
        <h4 style="margin-top: 24px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <span>‚è∞</span> Best Posting Times
        </h4>
        <div class="time-grid" id="postingTimes"></div>
        <div class="days-chips" id="bestDays"></div>
    </div>
</div>

<script>
    let selectedAudience = 'general';
    let selectedPlatform = 'instagram';
    let selectedCampaign = 'awareness';
    let selectedFocus = 'balanced';
    let currentHashtags = '';
    let currentCaption = '';
    let currentAnalyzedCaption = '';
    let isAnalyzeMode = false;

    // Load trending topics on page load
    document.addEventListener('DOMContentLoaded', loadTrendingTopics);

    function switchTab(tab) {
        // Update tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.tab-btn:nth-child(${tab === 'generate' ? 1 : 2})`).classList.add('active');

        // Update tab content
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById(tab === 'generate' ? 'generateTab' : 'analyzeTab').classList.add('active');
    }

    function selectChip(chip, type) {
        const selector = chip.parentElement;
        selector.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        chip.classList.add('active');

        const value = chip.dataset.value;
        if (type === 'audience') selectedAudience = value;
        if (type === 'platform') selectedPlatform = value;
        if (type === 'campaign') selectedCampaign = value;
        if (type === 'focus') selectedFocus = value;
    }

    function selectTrending(topic) {
        document.getElementById('topicInput').value = topic;
    }

    async function loadTrendingTopics() {
        try {
            const response = await fetch('/api/discovery/trending');
            const data = await response.json();

            if (data.success && data.trending) {
                const chips = data.trending.slice(0, 5).map(t => `
                    <button class="trending-chip" onclick="selectTrending('${t.topic}')">
                        ${t.hashtag} <span class="trending-score">${t.trending_score}</span>
                    </button>
                `).join('');
                document.getElementById('trendingChips').innerHTML = chips;
            }
        } catch (e) {
            console.error('Failed to load trending topics:', e);
        }
    }

    function updateCharCount() {
        const caption = document.getElementById('captionInput').value;
        document.getElementById('charCount').textContent = caption.length;
    }

    async function generateCaption() {
        const topic = document.getElementById('topicInput').value.trim();
        if (!topic) {
            alert('Please enter a topic');
            return;
        }

        isAnalyzeMode = false;
        const btn = document.getElementById('generateBtn');
        btn.classList.add('loading');
        btn.disabled = true;

        // Hide analyzed caption box if visible
        document.getElementById('analyzedCaptionBox').classList.add('hidden');

        try {
            const response = await fetch('/api/discovery/generate-caption', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    topic: topic,
                    target_audience: selectedAudience,
                    platform: selectedPlatform,
                    campaign_type: selectedCampaign,
                    optimization_focus: selectedFocus
                })
            });

            const data = await response.json();

            if (data.success) {
                currentCaption = data.caption;
                displayGeneratedResults(data);

                // Also run multi-optimization analysis
                const optResponse = await fetch('/api/discovery/multi-optimize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        caption: data.caption,
                        topic: topic,
                        platform: selectedPlatform
                    })
                });
                const optData = await optResponse.json();
                if (optData.success) {
                    displayOptimizationCards(optData.optimization);
                }
            } else {
                alert('Error: ' + (data.error || 'Generation failed'));
            }
        } catch (error) {
            console.error('Generation error:', error);
            alert('Failed to generate caption. Please try again.');
        } finally {
            btn.classList.remove('loading');
            btn.disabled = false;
        }
    }

    async function analyzeCaption() {
        const caption = document.getElementById('captionInput').value.trim();
        if (!caption) {
            alert('Please paste a caption to analyze');
            return;
        }

        isAnalyzeMode = true;
        const btn = document.getElementById('analyzeBtn');
        btn.classList.add('loading');
        btn.disabled = true;

        try {
            // Run both analyses in parallel
            const [analyzeResponse, optResponse] = await Promise.all([
                fetch('/api/discovery/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        caption: caption,
                        platform: selectedPlatform,
                        target_audience: selectedAudience,
                        campaign_type: selectedCampaign
                    })
                }),
                fetch('/api/discovery/multi-optimize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        caption: caption,
                        topic: 'domestic violence awareness',
                        platform: selectedPlatform
                    })
                })
            ]);

            const [analyzeData, optData] = await Promise.all([
                analyzeResponse.json(),
                optResponse.json()
            ]);

            if (analyzeData.success) {
                displayAnalysisResults(analyzeData.analysis);
            }

            if (optData.success) {
                displayOptimizationCards(optData.optimization);
            }

        } catch (error) {
            console.error('Analysis error:', error);
            alert('Failed to analyze caption. Please try again.');
        } finally {
            btn.classList.remove('loading');
            btn.disabled = false;
        }
    }

    function displayGeneratedResults(data) {
        // Show results panel
        document.getElementById('resultsPanel').classList.add('visible');

        // Show generated caption
        const captionBox = document.getElementById('generatedCaptionBox');
        captionBox.classList.remove('hidden');
        document.getElementById('generatedCaptionText').textContent = data.caption;

        // Display hashtags
        if (data.hashtags) {
            currentHashtags = data.hashtags.map(h => '#' + h.replace('#', '')).join(' ');
            document.getElementById('hashtagList').innerHTML = data.hashtags.map(tag =>
                `<span class="hashtag-tag">#${tag.replace('#', '')}</span>`
            ).join('');
        }

        // Display posting times
        if (data.posting_times) {
            const times = data.posting_times;
            document.getElementById('postingTimes').innerHTML = `
                <div class="time-card best">
                    <div class="time-label">Best Times</div>
                    <div class="time-value">${times.best.join(' & ')}</div>
                </div>
                <div class="time-card">
                    <div class="time-label">Also Good</div>
                    <div class="time-value">${times.good.slice(0, 2).join(', ')}</div>
                </div>
            `;
            document.getElementById('bestDays').innerHTML = `
                <strong style="margin-right: 8px;">Best days:</strong>
                ${times.days.map(day => `<span class="day-chip">${day}</span>`).join('')}
            `;
        }

        // Show improvement suggestions if score is low
        const improvementBox = document.getElementById('improvementBox');
        if (data.needs_improvement && data.improvement_suggestions) {
            improvementBox.classList.remove('hidden');
            document.getElementById('improvementList').innerHTML = data.improvement_suggestions.map(tip =>
                `<li>${tip}</li>`
            ).join('');
        } else {
            improvementBox.classList.add('hidden');
        }
    }

    function displayAnalysisResults(analysis) {
        // Show results panel
        document.getElementById('resultsPanel').classList.add('visible');

        // Hide generated caption box, show analyzed caption box
        document.getElementById('generatedCaptionBox').classList.add('hidden');
        const analyzedBox = document.getElementById('analyzedCaptionBox');
        analyzedBox.classList.remove('hidden');

        // Store and display the analyzed caption
        const analyzedCaption = document.getElementById('captionInput').value;
        currentAnalyzedCaption = analyzedCaption;
        document.getElementById('analyzedCaptionText').textContent = analyzedCaption.substring(0, 200) + (analyzedCaption.length > 200 ? '...' : '');

        // Display score with description
        const score = analysis.discovery_score;
        const scoreCard = document.querySelector('.overall-score-card');
        scoreCard.className = 'overall-score-card grade-' + score.grade.toLowerCase();
        document.getElementById('overallGrade').textContent = score.grade;
        document.getElementById('overallGrade').style.color = score.color;

        // Score descriptions
        const descriptions = {
            'A': 'üéâ Excellent! Your caption is highly optimized.',
            'B': 'üëç Good! Minor tweaks could boost discoverability.',
            'C': 'üìà Decent. Consider adding key elements for better reach.',
            'D': '‚ö†Ô∏è Needs work. Use AI optimization to improve.',
            'F': 'üîß Low score. Click "Optimize with AI" for a better version.'
        };
        document.getElementById('scoreDescription').textContent = descriptions[score.grade] || '';

        // Display hashtags
        if (analysis.hashtags) {
            currentHashtags = analysis.hashtag_string;
            document.getElementById('hashtagList').innerHTML = analysis.hashtags.map(tag =>
                `<span class="hashtag-tag">#${tag.replace('#', '')}</span>`
            ).join('');
        }

        // Display posting times
        if (analysis.posting_times) {
            const times = analysis.posting_times;
            document.getElementById('postingTimes').innerHTML = `
                <div class="time-card best">
                    <div class="time-label">Best Times</div>
                    <div class="time-value">${times.best.join(' & ')}</div>
                </div>
                <div class="time-card">
                    <div class="time-label">Also Good</div>
                    <div class="time-value">${times.good.slice(0, 2).join(', ')}</div>
                </div>
            `;
            document.getElementById('bestDays').innerHTML = `
                <strong style="margin-right: 8px;">Best days:</strong>
                ${times.days.map(day => `<span class="day-chip">${day}</span>`).join('')}
            `;
        }
    }

    function displayOptimizationCards(opt) {
        // Show optimization cards
        document.getElementById('optCards').classList.remove('hidden');

        // Update each card
        updateOptCard('seo', opt.seo);
        updateOptCard('aio', opt.aio);
        updateOptCard('geo', opt.geo);
        updateOptCard('aeo', opt.aeo);

        // Update overall score if available
        if (opt.overall_grade) {
            const scoreCard = document.querySelector('.overall-score-card');
            scoreCard.className = 'overall-score-card grade-' + opt.overall_grade.toLowerCase();
            document.getElementById('overallGrade').textContent = opt.overall_grade;
            const color = opt.overall_score >= 80 ? '#22c55e' : opt.overall_score >= 60 ? '#eab308' : '#ef4444';
            document.getElementById('overallGrade').style.color = color;

            // Score descriptions
            const descriptions = {
                'A': 'üéâ Excellent! Highly optimized for discoverability.',
                'B': 'üëç Good! Minor tweaks could boost reach further.',
                'C': 'üìà Decent. Adding key elements will improve score.',
                'D': '‚ö†Ô∏è Needs work. Use suggestions below to improve.',
                'F': 'üîß Low score. Click improve button for a better version.'
            };
            document.getElementById('scoreDescription').textContent = descriptions[opt.overall_grade] || '';
        }

        // Collect all tips for improvement suggestions
        const allTips = [
            ...opt.seo.tips.slice(0, 2),
            ...opt.aio.tips.slice(0, 1),
            ...opt.geo.tips.slice(0, 1),
            ...opt.aeo.tips.slice(0, 1)
        ].filter(tip => tip).slice(0, 5);

        // Show improvement box if score is below A
        const improvementBox = document.getElementById('improvementBox');
        if (opt.overall_score < 90 && allTips.length > 0) {
            improvementBox.classList.remove('hidden');
            document.getElementById('improvementList').innerHTML = allTips.map(tip =>
                `<li>${tip}</li>`
            ).join('');
            // Update button text based on mode
            document.getElementById('improveBtn').textContent = isAnalyzeMode ? '‚ú® Optimize with AI' : '‚ú® Generate Improved Version';
        } else {
            improvementBox.classList.add('hidden');
        }
    }

    function updateOptCard(type, data) {
        document.getElementById(`${type}Grade`).textContent = data.grade;

        const tipsHtml = data.tips.slice(0, 3).map(tip =>
            `<div class="opt-tip">${tip}</div>`
        ).join('');
        document.getElementById(`${type}Tips`).innerHTML = tipsHtml || '<div class="opt-tip" style="color: #22c55e;">‚úì Well optimized!</div>';
    }

    function copyHashtags() {
        if (!currentHashtags) return;

        navigator.clipboard.writeText(currentHashtags).then(() => {
            const btn = document.querySelector('.copy-btn');
            btn.classList.add('copied');
            document.getElementById('copyIcon').textContent = '‚úì';
            document.getElementById('copyText').textContent = 'Copied!';

            setTimeout(() => {
                btn.classList.remove('copied');
                document.getElementById('copyIcon').textContent = 'üìã';
                document.getElementById('copyText').textContent = 'Copy All';
            }, 2000);
        });
    }

    function copyGeneratedCaption() {
        if (!currentCaption) return;

        const fullText = currentCaption + '\n\n' + currentHashtags;
        navigator.clipboard.writeText(fullText).then(() => {
            const btn = document.querySelector('.copy-caption-btn');
            btn.textContent = '‚úì Copied!';
            btn.classList.add('copied');

            setTimeout(() => {
                btn.textContent = 'üìã Copy';
                btn.classList.remove('copied');
            }, 2000);
        });
    }

    async function regenerateImproved() {
        // Use optimizeWithAI for both modes
        if (isAnalyzeMode) {
            return optimizeWithAI();
        }

        const topic = document.getElementById('topicInput').value.trim();
        if (!topic) {
            alert('Please enter a topic first');
            return;
        }

        const improveBtn = document.querySelector('.improve-btn');
        const originalText = improveBtn.innerHTML;
        improveBtn.innerHTML = '‚è≥ Improving...';
        improveBtn.disabled = true;

        try {
            const response = await fetch('/api/discovery/generate-caption', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    topic: topic,
                    target_audience: selectedAudience,
                    platform: selectedPlatform,
                    campaign_type: selectedCampaign,
                    optimization_focus: selectedFocus,
                    enhance: true  // Flag for enhanced generation
                })
            });

            const data = await response.json();

            if (data.success) {
                currentCaption = data.caption;
                isAnalyzeMode = false;
                document.getElementById('analyzedCaptionBox').classList.add('hidden');
                displayGeneratedResults(data);

                // Also run multi-optimization analysis
                const optResponse = await fetch('/api/discovery/multi-optimize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        caption: data.caption,
                        topic: topic,
                        platform: selectedPlatform
                    })
                });
                const optData = await optResponse.json();
                if (optData.success) {
                    displayOptimizationCards(optData.optimization);
                }

                // Hide improvement box after regenerating
                document.getElementById('improvementBox').classList.add('hidden');
            } else {
                alert('Error: ' + (data.error || 'Generation failed'));
            }
        } catch (error) {
            console.error('Regeneration error:', error);
            alert('Failed to regenerate caption. Please try again.');
        } finally {
            improveBtn.innerHTML = originalText;
            improveBtn.disabled = false;
        }
    }

    async function optimizeWithAI() {
        // Extract topic from analyzed caption or use a default
        const originalCaption = currentAnalyzedCaption || document.getElementById('captionInput').value.trim();
        if (!originalCaption) {
            alert('No caption to optimize');
            return;
        }

        // Extract key theme from the original caption for topic
        const topic = extractTopicFromCaption(originalCaption);

        const optimizeBtn = document.querySelector('.optimize-ai-btn');
        const improveBtn = document.querySelector('.improve-btn');
        const originalBtnText = optimizeBtn ? optimizeBtn.innerHTML : '';
        const originalImproveBtnText = improveBtn ? improveBtn.innerHTML : '';

        if (optimizeBtn) {
            optimizeBtn.innerHTML = '‚è≥ Optimizing...';
            optimizeBtn.disabled = true;
        }
        if (improveBtn) {
            improveBtn.innerHTML = '‚è≥ Optimizing...';
            improveBtn.disabled = true;
        }

        try {
            const response = await fetch('/api/discovery/generate-caption', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    topic: topic,
                    target_audience: selectedAudience,
                    platform: selectedPlatform,
                    campaign_type: selectedCampaign,
                    optimization_focus: 'balanced',
                    enhance: true,
                    original_caption: originalCaption  // Pass original for context
                })
            });

            const data = await response.json();

            if (data.success) {
                currentCaption = data.caption;
                isAnalyzeMode = false;

                // Hide analyzed caption box, show generated
                document.getElementById('analyzedCaptionBox').classList.add('hidden');
                displayGeneratedResults(data);

                // Run multi-optimization analysis
                const optResponse = await fetch('/api/discovery/multi-optimize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        caption: data.caption,
                        topic: topic,
                        platform: selectedPlatform
                    })
                });
                const optData = await optResponse.json();
                if (optData.success) {
                    displayOptimizationCards(optData.optimization);
                }

                // Hide improvement box
                document.getElementById('improvementBox').classList.add('hidden');
            } else {
                alert('Error: ' + (data.error || 'Optimization failed'));
            }
        } catch (error) {
            console.error('Optimization error:', error);
            alert('Failed to optimize caption. Please try again.');
        } finally {
            if (optimizeBtn) {
                optimizeBtn.innerHTML = originalBtnText || '‚ú® Optimize with AI';
                optimizeBtn.disabled = false;
            }
            if (improveBtn) {
                improveBtn.innerHTML = originalImproveBtnText || '‚ú® Generate Improved Version';
                improveBtn.disabled = false;
            }
        }
    }

    function extractTopicFromCaption(caption) {
        // Extract key topic from caption text
        const keywords = ['domestic violence', 'teen dating', 'healthy relationship', 'safety', 'support',
                         'survivor', 'awareness', 'help', 'abuse', 'prevention'];
        const lowerCaption = caption.toLowerCase();

        for (const keyword of keywords) {
            if (lowerCaption.includes(keyword)) {
                return keyword.charAt(0).toUpperCase() + keyword.slice(1) + ' awareness';
            }
        }
        return 'Domestic violence awareness and support';
    }

    // Initialize
    updateCharCount();
</script>
{% endblock %}
